---
description: >-
  Active Directory enumeration with PowerShell leveraging the Lightweight
  Directory Access Protocol (LDAP), part of Active Directory Service Interfaces
  (ADSI)
---

# With Powershell

### Useful targets:&#x20;

Domain Admins - control every computer of that domain.

Domain Controller (DC) - control every computer and access all password hashes on that domain .

{% hint style="info" %}
Should Powershell execution policies may prevent script execution, use:\
PS C:\\> Set-ExecutionPolicy Unrestricted
{% endhint %}

### Enumerate the Domain

```
PS C:\Users\pfry> [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()


Forest                  : FUTURAMA.local
DomainControllers       : {Bender.FUTURAMA.local}
Children                : {}
DomainMode              : Unknown
DomainModeLevel         : 7
Parent                  :
PdcRoleOwner            : Bender.FUTURAMA.local
RidRoleOwner            : Bender.FUTURAMA.local
InfrastructureRoleOwner : Bender.FUTURAMA.local
Name                    : FUTURAMA.local
```

### Enumerate PdcRoleOwner to LDAP://

```
# ps-ldap-domain-provider.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$SearchString
```

```
PS C:\Users\pfry> .\ps-ldap-domain-provider.ps1
LDAP://Bender.FUTURAMA.local/DC=FUTURAMA,DC=local
```

### Enumerate Users with recursive LDAP search

```
# ps-directory-searcher.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter="samAccountType=805306368"		# SAM_USER_OBJECT 0x30000000

$Result = $Searcher.FindAll()

Foreach($obj in $Result)
{
    Foreach($prop in $obj.Properties)
    {
        $prop
    }
    
    Write-Host "------------------------------------------------"
}
```

{% hint style="info" %}
Filter by SAM-Account-Type [https://docs.microsoft.com/en-gb/windows/win32/adschema/a-samaccounttype](https://docs.microsoft.com/en-gb/windows/win32/adschema/a-samaccounttype)
{% endhint %}

```
PS C:\Users\pfry> .\ps-directory-searcher.ps1

Name                           Value
----                           -----
logoncount                     {20}
codepage                       {0}
objectcategory                 {CN=Person,CN=Schema,CN=Configuration,DC=FUTURAMA,DC=local}
description                    {Built-in account for administering the computer/domain}
usnchanged                     {37190}
instancetype                   {4}
name                           {Administrator}
badpasswordtime                {132892915527850576}
pwdlastset                     {132892903300500009}
objectclass                    {top, person, organizationalPerson, user}
...
```

{% hint style="info" %}
Modify $Search.filter with properties from SAM-Account-Type to filter down further.
{% endhint %}

### Group Account Enumeration

```
# ps-group-searcher.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter="(objectClass=Group)"

$Result = $Searcher.FindAll()

Foreach($obj in $Result)
{
    $obj.Properties.name
}
```

```
PS C:\Users\pfry> .\ps-group-searcher.ps1
Administrators
Users
Guests
Print Operators
Backup Operators
Replicator
Remote Desktop Users
Network Configuration Operators
Performance Monitor Users
Performance Log Users
Distributed COM Users
IIS_IUSRS
Cryptographic Operators
Event Log Readers
Certificate Service DCOM Access
RDS Remote Access Servers
RDS Endpoint Servers
...
```

### Enumerate Members of  a Group

```
# ps-enumerate-group-members.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter="(&(objectCategory=group)(name=Domain Admins))"

$Result = $Searcher.FindAll()

Foreach($obj in $Result)
{
    Foreach($prop in $obj.Properties)
    {
        $prop.member
    }
    Write-Host "------------------------------------------------"
}
```

### Nested Group Member Enumeration

```
# ps-nested-group-members.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter="(name=Mops_and_Buckets)"

$Result = $Searcher.FindAll()

Foreach($obj in $Result)
{
    $obj.Properties.member
}
```

```
PS C:\Users\pfry> .\ps-nested-group-members.ps1
CN=Scruffys_Secr3t_Gr0up,OU=Groups,DC=FUTURAMA,DC=local
```

{% hint style="info" %}
By running this same search multiple times, each time changing the searched group name to the out put of the last, we can enumerate the nested groups. eg. the next run of this search would have $Searcher.filter="(name=Scruffys\_Secr3t\_Gr0up)"
{% endhint %}

### Computer Enumeration

```
# ps-computer-enum.ps1
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

$Searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]$SearchString)

$objDomain = New-Object System.DirectoryServices.DirectoryEntry

$Searcher.SearchRoot = $objDomain

$Searcher.filter="(objectCategory=Computer)"

$Result = $Searcher.FindAll()

Foreach($obj in $Result)
{
    Foreach($prop in $obj.Properties)
    {
        $prop.name
        $prop.dnshostname
        $prop.operatingsystem
        $prop.operatingsystemversion
    }
    Write-Host "------------------------------------------------"
}
```

